<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.palmcms.api.cms.CmsMapper">

    <select id="selectUserCmssInfoByUserId" resultType="com.palmcms.api.cms.UserVO">
        select U.userLoginId, U.userName, U.proviName, U.nickName, U.contactNo
                , U.socialRegNumber, CH.churchName
                , U.userStatus, C1.codeName userStatusName
                , B.unpaidAmt
        from TO_USER U
                 join TO_CHURCH CH on U.churchId = CH.id
                 left outer join ( select userId, max(cmsbIllDay) cmsbIllDay from CMS_BILL where userId = #{userId}) BM on BM.userId = U.id
                 left outer join CMS_BILL B on B.userId = BM.userId and B.cmsBillDay = BM.cmsbIllDay
                 left outer join TO_COMMON_CODE C1 on C1.codeGroup = 'userStatus' and C1.code  = U.userStatus
        where U.id = #{userId}
    </select>

    <select id="selectCmsInfoByPayerNo" resultType="com.palmcms.api.cms.CmsUserVO">
        select CU.payerNo, CU.payerName, CU.payerNo, CU.contactNo, CU.status
          , case when socialRegNumber is null then birthday else socialRegNumber end socialRegNumber
        from CMS_USER CU
        where CU.payerNO = #{payerNO}
    </select>

    <select id="selectManagersByChurchId" resultType="com.palmcms.api.cms.ManagerVO">
        select U.userName managerName, U.contactNo managerContactNo from TO_USER_MANAGE_CHURCH UMC
                                                                             join TO_USER U on U.id = UMC.userId
                                                                             join TO_USER_AUTHORITY UA on UA.authorityName = 'ROLE_CUSTOMER' and UA.userId = U.id
        where UMC.churchId = #{churcId}
    </select>

    <select id="selectApplicationsByUserId" resultType="com.palmcms.api.domain.DTO.CmsApplicationDTO">
        select * from CMS_APPLICATION
        where userId = #{userId}
        order by id desc
    </select>

    <insert id="insertCmsApp">
        insert into CMS_APPLICATION
        (
            userId, userName, proviName, nickName, userContactNo, userSocialRegNumber, userSign
            , productName, productPrice, productServiceMonth
            , holderName, selfYN, relation, bankCode, acctNo, holderContactNo, holderSocialRegNumber, holderSign
            , cmsAppStatus
            , creationDate, modificationDate
        )
        values
        (
            #{userId}, #{userName}, #{proviName}, #{nickName}, #{userContactNo}, #{userSocialRegNumber}, #{userSign}
            , #{productName}, #{productPrice}, #{productServiceMonth}
            , #{holderName}, #{selfYN}, #{relation}, #{bankCode}, #{acctNo}, #{holderContactNo}, #{holderSign}
            , #{holderSocialRegNumber}, 'NEW'
            , sysdate(), sysdate()
        )

    </insert>

</mapper>